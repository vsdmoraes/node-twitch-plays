'use strict'

var pinkyjs = require('./pinky.js')
var server = pinkyjs.startServer({ port: 7000 })

var pinky = pinkyjs.createSpawn()

// testKonamiCode(function (err, success) {
//   if (err) throw err
//   console.log('konami success: ' + success)
// })

pinky.createPage({
  camera: function (jpegBase64) {
    server.set(jpegBase64)
  }
}, function (err, page) {
  if (err) throw err

  console.log('page created')

  page.open('https://ip-spot.com', function (err) {
    if (err) throw err
    page.eval(function () {
      return document.body.textContent.trim()
    }, function (err, result) {
      if (err) throw err

      console.log('result: ' + result)
      page.close()

      pinky.createPage({
        camera: function (jpegBase64) {
          server.set(jpegBase64)
        }
      }, function (err, page) {
        if (err) throw err

        console.log('page created')

        // http://i.imgur.com/8urui5O.gif
        page.open('http://i.imgur.com/hw9MKFA.gif', function (err) {
          if (err) throw err

          setTimeout(function () {
            page.eval(function () {
              return document.body.textContent.trim()
            }, function (err, result) {
              if (err) throw err

              console.log('result.length: ' + result.length)
              page.close()

              page.open('http://i.imgur.com/8urui5O.gif', function (err) {
                if (err) throw err

                setTimeout(function () {
                  page.eval(function () {
                    return document.body.textContent.trim()
                  }, function (err, result) {
                    if (err) throw err

                    console.log('result.length: ' + result.length)
                    page.close()
                  })
                }, 5000)
              })

            })
          }, 5000)
        })
      })

    })
  })
})

function testKonamiCode (callback) {
  // konami code: up up down down left right left right B A
  var pinky = pinkyjs({
    showMode: true
  },function (err, page) {
    if (err) throw err

    page.open('http://konamicodesites.com', function (err) {
      if (err) throw err

      console.log('page opened')
      page.wait('#start', function (err) {
        if (err) throw err

        console.log('entering konami code...')
        page.keyboard([
          page.event.key.Up,
          page.event.key.Up,
          page.event.key.Down,
          page.event.key.Down,
          page.event.key.Left,
          page.event.key.Right,
          page.event.key.Left,
          page.event.key.Right,
          'BA'
        ], function (err) {
          if (err) throw err

          setTimeout(function () {
            page.eval(function () {
              return !!document.getElementById('start')
            }, function (err, elFound) {
              if (elFound) {
                // failed to enter konami code
                console.log('konami code failed.')
                callback(undefined, false)
              } else {
                // konami code entered successfully
                console.log('konami code success!')
                callback(undefined, true)
              }
              pinky.exit()
            })
          }, 2500)
        })
      })
    })
  })
}
